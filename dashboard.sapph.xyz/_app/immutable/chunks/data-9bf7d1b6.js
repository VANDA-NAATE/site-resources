var Me=Object.defineProperty;var Ee=(n,e,t)=>e in n?Me(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var q=(n,e,t)=>(Ee(n,typeof e!="symbol"?e+"":e,t),t);import{w as h}from"./index-2eba6212.js";var H={exports:{}},w=typeof Reflect=="object"?Reflect:null,de=w&&typeof w.apply=="function"?w.apply:function(e,t,s){return Function.prototype.apply.call(e,t,s)},U;w&&typeof w.ownKeys=="function"?U=w.ownKeys:Object.getOwnPropertySymbols?U=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:U=function(e){return Object.getOwnPropertyNames(e)};function je(n){console&&console.warn&&console.warn(n)}var ve=Number.isNaN||function(e){return e!==e};function m(){m.init.call(this)}H.exports=m;H.exports.once=Fe;m.EventEmitter=m;m.prototype._events=void 0;m.prototype._eventsCount=0;m.prototype._maxListeners=void 0;var he=10;function K(n){if(typeof n!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n)}Object.defineProperty(m,"defaultMaxListeners",{enumerable:!0,get:function(){return he},set:function(n){if(typeof n!="number"||n<0||ve(n))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+n+".");he=n}});m.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};m.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||ve(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function ge(n){return n._maxListeners===void 0?m.defaultMaxListeners:n._maxListeners}m.prototype.getMaxListeners=function(){return ge(this)};m.prototype.emit=function(e){for(var t=[],s=1;s<arguments.length;s++)t.push(arguments[s]);var i=e==="error",o=this._events;if(o!==void 0)i=i&&o.error===void 0;else if(!i)return!1;if(i){var a;if(t.length>0&&(a=t[0]),a instanceof Error)throw a;var d=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw d.context=a,d}var y=o[e];if(y===void 0)return!1;if(typeof y=="function")de(y,this,t);else for(var O=y.length,W=Oe(y,O),s=0;s<O;++s)de(W[s],this,t);return!0};function ye(n,e,t,s){var i,o,a;if(K(t),o=n._events,o===void 0?(o=n._events=Object.create(null),n._eventsCount=0):(o.newListener!==void 0&&(n.emit("newListener",e,t.listener?t.listener:t),o=n._events),a=o[e]),a===void 0)a=o[e]=t,++n._eventsCount;else if(typeof a=="function"?a=o[e]=s?[t,a]:[a,t]:s?a.unshift(t):a.push(t),i=ge(n),i>0&&a.length>i&&!a.warned){a.warned=!0;var d=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");d.name="MaxListenersExceededWarning",d.emitter=n,d.type=e,d.count=a.length,je(d)}return n}m.prototype.addListener=function(e,t){return ye(this,e,t,!1)};m.prototype.on=m.prototype.addListener;m.prototype.prependListener=function(e,t){return ye(this,e,t,!0)};function xe(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function we(n,e,t){var s={fired:!1,wrapFn:void 0,target:n,type:e,listener:t},i=xe.bind(s);return i.listener=t,s.wrapFn=i,i}m.prototype.once=function(e,t){return K(t),this.on(e,we(this,e,t)),this};m.prototype.prependOnceListener=function(e,t){return K(t),this.prependListener(e,we(this,e,t)),this};m.prototype.removeListener=function(e,t){var s,i,o,a,d;if(K(t),i=this._events,i===void 0)return this;if(s=i[e],s===void 0)return this;if(s===t||s.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,s.listener||t));else if(typeof s!="function"){for(o=-1,a=s.length-1;a>=0;a--)if(s[a]===t||s[a].listener===t){d=s[a].listener,o=a;break}if(o<0)return this;o===0?s.shift():Ce(s,o),s.length===1&&(i[e]=s[0]),i.removeListener!==void 0&&this.emit("removeListener",e,d||t)}return this};m.prototype.off=m.prototype.removeListener;m.prototype.removeAllListeners=function(e){var t,s,i;if(s=this._events,s===void 0)return this;if(s.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):s[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete s[e]),this;if(arguments.length===0){var o=Object.keys(s),a;for(i=0;i<o.length;++i)a=o[i],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=s[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this};function Le(n,e,t){var s=n._events;if(s===void 0)return[];var i=s[e];return i===void 0?[]:typeof i=="function"?t?[i.listener||i]:[i]:t?Ne(i):Oe(i,i.length)}m.prototype.listeners=function(e){return Le(this,e,!0)};m.prototype.rawListeners=function(e){return Le(this,e,!1)};m.listenerCount=function(n,e){return typeof n.listenerCount=="function"?n.listenerCount(e):_e.call(n,e)};m.prototype.listenerCount=_e;function _e(n){var e=this._events;if(e!==void 0){var t=e[n];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}m.prototype.eventNames=function(){return this._eventsCount>0?U(this._events):[]};function Oe(n,e){for(var t=new Array(e),s=0;s<e;++s)t[s]=n[s];return t}function Ce(n,e){for(;e+1<n.length;e++)n[e]=n[e+1];n.pop()}function Ne(n){for(var e=new Array(n.length),t=0;t<e.length;++t)e[t]=n[t].listener||n[t];return e}function Fe(n,e){return new Promise(function(t,s){function i(a){n.removeListener(e,o),s(a)}function o(){typeof n.removeListener=="function"&&n.removeListener("error",i),t([].slice.call(arguments))}Se(n,e,o,{once:!0}),e!=="error"&&Be(n,i,{once:!0})})}function Be(n,e,t){typeof n.on=="function"&&Se(n,"error",e,t)}function Se(n,e,t,s){if(typeof n.on=="function")s.once?n.once(e,t):n.on(e,t);else if(typeof n.addEventListener=="function")n.addEventListener(e,function i(o){s.once&&n.removeEventListener(e,i),t(o)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n)}var _=function n(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){if(e.constructor!==t.constructor)return!1;var s,i,o;if(Array.isArray(e)){if(s=e.length,s!=t.length)return!1;for(i=s;i--!==0;)if(!n(e[i],t[i]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();if(o=Object.keys(e),s=o.length,s!==Object.keys(t).length)return!1;for(i=s;i--!==0;)if(!Object.prototype.hasOwnProperty.call(t,o[i]))return!1;for(i=s;i--!==0;){var a=o[i];if(!n(e[a],t[a]))return!1}return!0}return e!==e&&t!==t};let I={},Je=new H.exports.EventEmitter,Te=h(null),$e=h(null),ke=h(!1),De=h({key:null,data:null}),Ue=h(null),He=h(!1),Ke=h(0),We=h(0);function qe(){Je.emit("nav")}function Ie(n,e){if(I[`${n}-${e}`])return I[`${n}-${e}`];let t=Pe(n,e);return I[`${n}-${e}`]=t,t}let V=h(null),Ve=h({showBackdrop:!1,showLoading:!1});var z;let D=(z=class extends H.exports.EventEmitter{constructor(e){super();q(this,"values",[]);this.data=e}get data(){return this.__data}set data(e){this._data?this._data.set(e):this._data=h(e),this.__data=e}show(e=null){let t=D.current;return t&&t.hide(),D.current=this,V.set(this),new Promise(s=>{this.callback=e?async()=>e(this.values,this.data.items):null,this.hide=(i=0)=>{var a,d;let o=(d=(a=this.data)==null?void 0:a.beforeHide)==null?void 0:d.call(a,i);o?(this.data=o,this.values=[],this.emit("set-values",[])):(D.current=null,V.set(null),s({code:i,values:this.values}))}})}hide(e=0){D.current=null,V.set(null)}setValue(e,t){this.values[e]={value:t},this.emit("set-values",this.values)}setItem(e,t){this.data.items[e]=t,this.emit("set-item",e,t)}removeItem(e){this.data.items=this.data.items.filter((t,s)=>s!==e),this.emit("remove-item",e)}},q(z,"current",null),z);function Pe(n,e){let t=h(null,p=>{p(null),n&&e&&f();async function f(u){let l=await fetch(`/api/v1/dashboard/items/${e}Data-${n}`).catch(()=>null);if((l==null?void 0:l.status)===404&&p({notfound:!0}),(l==null?void 0:l.status)!==200)return u?null:setTimeout(()=>{f(!0)},500);let g=await l.json();p({initial:{...g},current:{...g,_reset:1}})}return()=>{}}),s=[],i=[];function o(p,f){let u;return t.update(l=>(u={...l[p?"initial":"current"]},l)),f||delete u._reset,u}async function a(p,f,u=!1){let l=o();return!l||!p||f===void 0||l[p]===void 0?!1:(JSON.stringify(l[p])===JSON.stringify(f)||(u?(l[p]=f,await G(JSON.stringify(l))):t.update(g=>(g.current[p]=f,g))),!0)}async function d(p,f,u,l){a(p,f),l&&(typeof l=="function"?s=s.filter(l):s=s.filter(g=>g.action!==l)),s.push(u)}async function y(p,f){let u=o();return!u||!p||f===void 0||u[p]===void 0?!1:(JSON.stringify(u[p])===JSON.stringify(f)||t.update(l=>(l.current[p]=f,l.initial[p]=f,l)),!0)}async function O(p){i.push(p)}async function W(){i=[]}async function G(p){var S,X,b,Y,M,Z,E,ee,j,te,x,ne,C,re,N,se,F,ie,B,ae,J,oe,P,ue,A,fe,R,le,T,ce,$,me,k,pe;let f=o(!0),u=JSON.parse(JSON.stringify(o())),l;if(p||s.length)l=s.length>0?JSON.stringify(s):p;else if(e==="messages"){let c={customButtons:new Map((f.customButtons||[]).map(r=>[r.name,r])),customSelectMenus:new Map((f.customSelectMenus||[]).map(r=>[r.name,r])),kits:new Map((f.kits||[]).map(r=>[r._id,r])),messages:new Map((f.messages||[]).map(r=>[r.name,r])),templates:new Map((f.templates||[]).map(r=>[r.name,r])),templateFolders:new Map((f.templateFolders||[]).map(r=>[r.name,r]))};l=JSON.stringify({a:{customButtons:((X=(S=u.customButtons)==null?void 0:S.filter)==null?void 0:X.call(S,r=>!c.customButtons.has(r.name)))||[],customSelectMenus:((Y=(b=u.customSelectMenus)==null?void 0:b.filter)==null?void 0:Y.call(b,r=>!c.customSelectMenus.has(r.name)))||[],kits:((Z=(M=u.kits)==null?void 0:M.filter)==null?void 0:Z.call(M,r=>!c.kits.has(r._id)))||[],messages:((ee=(E=u.messages)==null?void 0:E.filter)==null?void 0:ee.call(E,r=>!c.messages.has(r.name)))||[],templates:((te=(j=u.templates)==null?void 0:j.filter)==null?void 0:te.call(j,r=>!c.templates.has(r.name)))||[],templateFolders:((ne=(x=u.templateFolders)==null?void 0:x.filter)==null?void 0:ne.call(x,r=>!c.templateFolders.has(r.name)))||[]},m:{customButtons:((re=(C=u.customButtons)==null?void 0:C.filter)==null?void 0:re.call(C,r=>c.customButtons.has(r.name)&&!_(r,c.customButtons.get(r.name))))||[],customSelectMenus:((se=(N=u.customSelectMenus)==null?void 0:N.filter)==null?void 0:se.call(N,r=>c.customSelectMenus.has(r.name)&&!_(r,c.customSelectMenus.get(r.name))))||[],messages:((ie=(F=u.messages)==null?void 0:F.filter)==null?void 0:ie.call(F,r=>c.messages.has(r.name)&&!_(r,c.messages.get(r.name))))||[],templates:((ae=(B=u.templates)==null?void 0:B.filter)==null?void 0:ae.call(B,r=>c.templates.has(r.name)&&!_(r,c.templates.get(r.name))))||[],templateFolders:((oe=(J=u.templateFolders)==null?void 0:J.filter)==null?void 0:oe.call(J,r=>c.templateFolders.has(r.name)&&!_(r,c.templateFolders.get(r.name))))||[]},d:{customButtons:((ue=(P=f.customButtons)==null?void 0:P.filter)==null?void 0:ue.call(P,r=>!u.customButtons.find(v=>v.name===r.name)).map(r=>r.name))||[],customSelectMenus:((fe=(A=f.customSelectMenus)==null?void 0:A.filter)==null?void 0:fe.call(A,r=>!u.customSelectMenus.find(v=>v.name===r.name)).map(r=>r.name))||[],kits:((le=(R=f.kits)==null?void 0:R.filter)==null?void 0:le.call(R,r=>!u.kits.find(v=>v._id===r._id)).map(r=>r._id))||[],messages:((ce=(T=f.messages)==null?void 0:T.filter)==null?void 0:ce.call(T,r=>!u.messages.find(v=>v.name===r.name)).map(r=>r.name))||[],templates:((me=($=f.templates)==null?void 0:$.filter)==null?void 0:me.call($,r=>!u.templates.find(v=>v.name===r.name)).map(r=>r.name))||[],templateFolders:((pe=(k=f.templateFolders)==null?void 0:k.filter)==null?void 0:pe.call(k,r=>!u.templateFolders.find(v=>v.name===r.name)).map(r=>r.name))||[]},o:{sendMessageConfig:u.sendMessageConfig}})}else l=JSON.stringify(u);let g="",L=await fetch(`/api/v1/dashboard/items/${e}Data-${n}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:l}).catch(c=>(console.log("Fetch failed - retrying... error:",c),fetch(`/api/v1/dashboard/items/${e}Data-${n}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:l}).catch(r=>{console.log("Fetch failed again - no longer retrying.",r),g="Save attempt failed multiple times. Please try saving changes again in a few seconds."})));if((L==null?void 0:L.status)!==200)return{success:!1,error:g||await L.json().then(c=>(c==null?void 0:c.error)||(c==null?void 0:c.message)||"Unknown error").catch(()=>"Unknown error")};s=[];let Q=await L.json();return t.update(c=>{let r=JSON.parse(JSON.stringify(e==="messages"?{...f,...Q}:{...Q}));return{initial:r,current:{...r,_reset:c.current._reset||c.current._reset===!1?0:!1}}}),i.length&&await Promise.all(i.map(c=>c())),{success:!0}}function be(p){t.update(f=>{if(p)return{initial:f.initial,current:{...f.current,_reset:f.current._reset+1}};let u=o(!0);return{initial:{...u},current:{...u,_reset:f.current._reset+1}}}),s=[]}return{subscribe:t.subscribe,get:o,update:a,softUpdate:y,stepUpdate:d,addSaveFunction:O,clearSaveFunctions:W,save:G,reset:be}}export{D as M,Je as S,Ie as a,$e as b,Ue as c,V as d,Ve as e,We as f,Te as g,Ke as m,He as n,qe as o,De as p,ke as u};
